# MTXQCvX_part4.Rmd - Metmax parser

## This section explains ...

- what MTXQCvX_part4.Rmd does
- how do input files need to look like
- which files are generated
- what the distinct checkboxes mean



This module provides the generation of suitable input files for MTXQCvX2 based on spreadsheet exported information by tools like metmax. 

M

## Input files
### Quantification - PeakAreas.csv^[Required for: all parameter, just not `calculation stable isotope incorporation`]

In order to perform absolute quantification of 

You need a file containing all extracted peak areas for each metabolite and file^[Tools/Options/Retention analysis, Parameter: Area]. The header of metmax-extracted files looks like shown below (see table 1). Please, remember to delete the second header row, representing the column loads for each file before saving as csv-file. Otherwise you end up with weird imported dataframes in R.
Quantification masses have to be updated while processing in ChromaToF prior the export of the data e.g., with a reference search^[See `vignette/ReferenceSearch`] or using statistical compare. pSIRM experiments require the definition of pTop5 masses^[Extended list of quant masses considering isotope incorporation] instead of top5 masses in the reference in order to take into account the shift of intensities induced by the application of stable isotopes^[Mandatory columns: name, mass, files]


```{r metmax_header, results='asis', echo=FALSE}

df = data.frame(name = c("Lac", "Pyr", "Cit"), mass = c(219, 174, 273), ri = c(1051, 1042, 1805), row.load = c(0.76, 0.65, 0.99), file_1 = c(15423, 56978, 1326), file_2 = c(135444, 46888, 23321), file_x = c(465486, 4354544, 132121))

knitr::kable(df, caption = c("Example metmax-extracted file containing peak areas."))


```

MTXQCvX_part4 takes care of the formatting and correct column names of the peak areas file and saves it^[`input/quant/quantMassAreasMatrix.csv`].  MTXQCvX_part4 generates also the file PeakDensities-Chroma.csv^[`input/gc/PeakDensities-Chroma.csv`], in case you have selected the option to include sum of area normalisation while knitting this module.


### Isotope incorporation - MIDs.csv^[Required for `calculation isotope incorporation`]

In order to determine the incorporation of stable isotopes MTXQCvX2 requires as an input the mass isotopomer distributions (MIDs) for each intermediate and measurement^[Tools/Options/Isotope concentrator; Parameter: IntensityOfMass]. Fragments for each intermediate have to be pre-defined in metmax at Tools/Options/metabolite masses. They can be imported^[`inst/template_files/MetMax_MIDs.txt`] or manually specified each by each. An example of the metmax output is shown in table 2. The output has to be saved as csv-file, including the deletion of the partial row `column.load`, respectively^[Mandatory columns: name, mass, files].


```{r metmax_header_mid, results='asis', echo=FALSE}

df2 = data.frame(name = c("Lac", "Lac", "Lac","Lac", "Lac"),
                mass = c(219, 220, 221, 222, 223),
                ri = rep(1051, 5),
                row.load = rep(0.85, 5),
                file_1 = c(31026, 3607, 1222, 188,0),
                file_2 = c(5165829,662277,111481,1003494,33542),
                file_x = c(5829,277,81,10023,342))

knitr::kable(df2, caption = "Example metmax-extracted file containing MIDs.")


```

MTXQCvX_part4 calculates the stable isotope incorporation and exports DataMatrix.csv as well as pSIRM_SpectraData.csv^[`input/inc/DataMatrix` & `pSIRM_SpectraData.csv`]. The mathematics behind are outlined in [@Pietzke2014]

**Important**: Extracted MIDs have to match with defined mass couples for each metabolite in MTXQCvX2^[`config_mtx/incorpo_calc_masses.csv`]. Please refer for more details to `vignettes/config_mtx-files`.


### Derivatisation efficiency - mz73.csv^[Required for: `sum of area normalisation`]

The extraction of intensities for the ion $m/z$ 73 works analogous to the extraction of MIDs^[Tools/Options/Isotope concentrator; Parameter: IntensityOfMass]. Mass ranges have to be defined for each intermediate for the mass 73 by defining starting and end mass with 73. MTXQCvX_part4 generates the file MassSum-73.csv^[`input/gc/MassSum-73.csv`]. Check `inst\template_files\` for reference. Hopefully soon a new metmax button extracting specific intensities across the batch.

